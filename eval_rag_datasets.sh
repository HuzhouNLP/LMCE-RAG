#!/bin/bash

# eval_rag_datasets.sh
# Usage (all optional):
#   ORIG_KB       Original LKIF file path (default: date-synthesis/qar_generation/results/QA-summary.jsonl)
#   REF_KB        Reduced LKIF file path (default: date-synthesis/qar_generation/results/QA-summary-ref.json)
#   NUM_SAMPLES   Number of sampled QA examples for evaluation (default: 50)
#   SEED          Random seed to ensure matched sampling (default: 42)
#   TOP_K         Number of top documents to retrieve (default: 3)
#   MAX_NEW_TOKENS  Maximum new tokens generated by the LLM (default: 256)
#   EVAL_ZERO_SHOT  Whether to evaluate zero-shot baseline (1 on, 0 off; default: 0)
#   LLM_PATH       Path to the generation model (default: Meta-Llama-3-8B-Instruct)
ORIG_KB=${1:-"date-synthesis/qar_generation/results/QA-summary-long-test.json"}
REF_KB=${2:-"date-synthesis/qar_generation/results/QA-summary-long-test.json"}
NUM_SAMPLES=${3:-50}
SEED=${4:-42}
TOP_K=${5:-3}
MAX_NEW_TOKENS=${6:-256}
EVAL_ZERO_SHOT=${7:-1}
LLM_PATH=${8:-"/path/to/lkif/Meta-Llama-3-8B-Instruct"}

# 切到项目根目录（兼容从任意位置调用）
SCRIPT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
cd "$SCRIPT_DIR" || exit 1

PYTHON=python

echo "[eval_rag_datasets] Configuration:"
echo "  ORIG_KB        = ${ORIG_KB}"
echo "  REF_KB         = ${REF_KB}"
echo "  NUM_SAMPLES    = ${NUM_SAMPLES}"
echo "  SEED           = ${SEED}"
echo "  TOP_K          = ${TOP_K}"
echo "  MAX_NEW_TOKENS = ${MAX_NEW_TOKENS}"
echo "  EVAL_ZERO_SHOT = ${EVAL_ZERO_SHOT}"
echo "  LLM_PATH       = ${LLM_PATH}"
echo "[eval_rag_datasets] Start running experiments/eval_rag_datasets.py ..."

# 构建 Python 命令参数（用数组，避免把引号传进 Python）
PYTHON_ARGS=(
    --orig_kb "${ORIG_KB}"
    --ref_kb "${REF_KB}"
    --num_samples "${NUM_SAMPLES}"
    --seed "${SEED}"
    --top_k "${TOP_K}"
    --max_new_tokens "${MAX_NEW_TOKENS}"
    --llm_path "${LLM_PATH}"
)

# 根据 EVAL_ZERO_SHOT 参数决定是否添加 zero-shot 评估
if [ "${EVAL_ZERO_SHOT}" = "1" ]; then
    PYTHON_ARGS+=( --evaluate_zero_shot )
fi

$PYTHON -u experiments/eval_rag_datasets.py "${PYTHON_ARGS[@]}"

echo "[eval_rag_datasets] Done."
